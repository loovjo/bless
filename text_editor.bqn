blessâ†â€¢Import "bless.bqn"

c â† bless.Curses@
c.Start@
c.Clear@

lines â† âŸ¨"line 1", "line 2", "more text", "last line"âŸ©
cursor â† 0â€¿0


Redraw â† {ğ•¤
    c.Clear @
    c.CursorHide@
    c.Style "bold"

    âŸ¨w,hâŸ© â† c.Size @
    {ğ•©â€¿0 c.PutText "-"â‹„ğ•©â€¿(h-1) c.PutText "-"}Â¨ 1+â†•(w-2)
    {0â€¿ğ•© c.PutText "|"â‹„(w-1)â€¿ğ•© c.PutText "|"}Â¨ 1+â†•(h-2)
    0â€¿0 c.PutText "+"
    (w-1)â€¿0 c.PutText "+"
    0â€¿(h-1) c.PutText "+"
    (w-1)â€¿(h-1) c.PutText "+"

    x_offset â† 6
    y_offset â† 1

    {F lâ€¿y:
        lineNo â† (â€¢Fmt y+1)âˆ¾" ~"
        c.Style "bold"
        (x_offset-1+â‰ lineno)â€¿(y+1) c.PutText lineNo
        c.Style "reset"
        6â€¿(y+y_offset) c.PutText l
    }Ë˜ linesâˆ¾Ë˜â†•â‰ lines

    c.MoveCursor cursor+x_offsetâ€¿y_offset
    c.CursorHideâ¼@
}

ReAlign â† {ğ•¤
    âŸ¨x,yâŸ© â† cursor
    y â†© 0âŒˆ(1-Ëœâ‰ lines)âŒŠy
    x â†© 0âŒˆ(â‰ yâŠ‘lines)âŒŠx
    cursor â†© âŸ¨x,yâŸ©
}

RunKey â† {
    F c : c > Â¯1 ?
        âŸ¨x,yâŸ© â† cursor
        lines ((xâŠ¸â†‘)âˆ¾(@+c)Ë™âˆ¾(xâŠ¸â†“))âŒ¾(yâŠ¸âŠ‘)â†©
        cursor +âŸœ1â€¿0â†©
    ;
    F k : (k = bless.keys.backspace) âˆ§ (0 = âŠ‘cursor) ?
        âŸ¨x,yâŸ© â† cursor
        line_here â† yâŠ‘lines
        prev_line â† (y-1)âŠ‘lines
        lines â†© ((y-1)â†‘lines) âˆ¾ (â‹ˆ prev_line âˆ¾ line_here) âˆ¾ ((y+1)â†“lines)
        cursor â†© (â‰ prev_line)â€¿(y-1)
    ;
    F k : k = bless.keys.backspace ?
        âŸ¨x,yâŸ© â† cursor
        lines (((x-1)âŠ¸â†‘)âˆ¾(xâŠ¸â†“))âŒ¾(yâŠ¸âŠ‘)â†©
        cursor +âŸœÂ¯1â€¿0â†©
    ;
    F k : k = bless.keys.return ?
        âŸ¨x,yâŸ© â† cursor
        line â† yâŠ‘lines
        lines â†© (yâ†‘lines) âˆ¾ (â‹ˆxâ†‘line) âˆ¾ (â‹ˆxâ†“line) âˆ¾ ((y+1)â†“lines)
        cursor â†© 0â€¿(y+1)
    ;
    F k : k = bless.keys.up    ? cursor +âŸœ0â€¿Â¯1â†© â‹„ ReAlign @;
    F k : k = bless.keys.down  ? cursor +âŸœ0â€¿ 1â†© â‹„ ReAlign @;
    F k : k = bless.keys.left  ? cursor +âŸœÂ¯1â€¿0â†© â‹„ ReAlign @;
    F k : k = bless.keys.right ? cursor +âŸœ 1â€¿0â†© â‹„ ReAlign @;
    F x : @
}

# Main loop
{ğ•¤
    Redraw @
    c.Flush@

    k â† c.ReadKey@

    RunKey k

    ğ•ŠâŸ(kâ‰ bless.keys.esc)@
}@

c.Stop@
