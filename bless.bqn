# Converts an array of numbers to a space separated string
Arr2Msg â† 1âŠ¸â†“ âˆ˜ âˆ¾ âˆ˜ ((" "Ë™âˆ¾â€¢Fmt)Â¨)

# Inverts Arr2Msg
Msg2Arr â† â€¢BQNÂ¨ âˆ˜ ((âŠ¢-Ëœ+`Ã—Â¬)âˆ˜(' 'âŠ¸=) âŠ” âŠ¢)

keys â‡ {
    broken â‡ Â¯1
    esc â‡ Â¯2
    return â‡ Â¯3
    backspace â‡ Â¯4
    up â‡ Â¯101
    down â‡ Â¯102
    left â‡ Â¯103
    right â‡ Â¯104
}

Key2Str â‡ {
    F x : x > Â¯1 ? @+x ;
    F Â¯1 : "BROKEN" ;
    F Â¯2 : "ESC" ;
    F Â¯3 : "RETURN" ;
    F Â¯4 : "BACKSPACE" ;
    F Â¯101 : "UP" ;
    F Â¯102 : "DOWN" ;
    F Â¯103 : "LEFT" ;
    F Â¯104 : "RIGHT" ;
    F x : "(unknown)"
}

Curses â‡ {ğ•¤
    âŸ¨exit_status, stdout, stderrâŸ© â† â€¢SH "python3"â€¿"bless.py"
    â€¢Delay 0.05 # hopefully the fifos will be opened and stuff

    {ğ•¤
        â€¢Out "bless.py error"
        â€¢Out "== stderr =="
        â€¢Out stderr
        â€¢Out "== =="
        "internal bless.py error" ! 1
    }âŸ(exit_statusâ‰ 0)@

    null â† stdout=@
    boci â‡ (0=+`null)/stdout
    bico â‡ (1=null-Ëœ+`null)/stdout
    logf â‡ (2=null-Ëœ+`null)/stdout

    Send â† {
        boci â€¢FBytes ğ•©âˆ¾â‹ˆ@
    }
    Recv â† {ğ•¤
        â€¢FChars bico
    }

    # Sets terminal mode to raw + cbreak
    Start â‡ SendâŸœ"start"
    Stop â‡ {ğ•¤
        Send "stop"
        Recv @
    }

    Flush â‡ SendâŸœ"flush"

    # Clears screen
    Clear â‡ SendâŸœ"clear"

    PutText â‡ {
    xâ€¿y F âŸ¨âŸ©:
        Send "puttext " âˆ¾ (Arr2Msg xâ€¿y)
    ;
    xâ€¿y F text:
        Send "puttext " âˆ¾ (Arr2Msg xâ€¿y) âˆ¾ " " âˆ¾ (Arr2Msg @-Ëœtext)
    }

    MoveCursor â‡ {F xâ€¿y:
        Send "puttext " âˆ¾ (Arr2Msg xâ€¿y)
    }

    # Defaults to setting foreground. If ğ•¨ = 1, sets background
    Foreground â‡ {
    F râ€¿gâ€¿b:
        Send "style color_foreground " âˆ¾ (Arr2Msg râ€¿gâ€¿b)
    ;
    0 F râ€¿gâ€¿b:
        Send "style color_foreground " âˆ¾ (Arr2Msg râ€¿gâ€¿b)
    ;
    1 F râ€¿gâ€¿b:
        Send "style color_background " âˆ¾ (Arr2Msg râ€¿gâ€¿b)
    }

    Style â‡ {
    F "reset":
        Send "style reset"
    ;
    F "bold":
        Send "style bold"
    ;
    F "underline":
        Send "style underline"
    }

    # Run inveres to show cursor
    CursorHide â‡ {
    ğ•Š:
        Send "style nocursor"
    ;
    ğ•Šâ¼:
        Send "style recursor"
    }

    Size â‡ {ğ•¤
        Send "getsize"
        Msg2Arr Recv @
    }

    # Reads one char. Blocks if no character is available.
    # Input is buffered, so if mulitple chars are typed before this function is called, only the first one will be returned, then the second one etc.
    ReadKey â‡ {ğ•¤
        Send "readchar_block"
        â€¢BQN Recv @
    }

    # Dumps the entire input buffer. Non-blocked
    ReadKeys â‡ {ğ•¤
        Send "readstr"
        Msg2Arr Recv @
    }
}
